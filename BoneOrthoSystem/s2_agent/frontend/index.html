<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Bone Assistant</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Microsoft JhengHei", sans-serif;
      background: #f2f4f5;
    }

    header {
      background: #00695c;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { margin: 0; font-size: 20px; }
    .session-box {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .session-box input {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      min-width: 120px;
    }

    main { padding: 16px; }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      min-height: 500px;
    }

    #messages {
      flex: 1;
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
      background: #fafafa;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 14px;
    }
    .msg { margin-bottom: 8px; padding: 6px 8px; border-radius: 4px; }
    .msg.system { background: #e0f2f1; color: #004d40; font-weight: 500; }
    .msg.user { background: #d0ebff; text-align: right; }
    .msg.assistant { background: #eeeeee; }
    .msg .label { font-weight: 600; margin-right: 4px; }

    #files-panel {
      padding: 8px 16px;
      font-size: 13px;
      border-bottom: 1px solid #e0e0e0;
      background: #f5f5f5;
      max-height: 140px;
      overflow-y: auto;
    }
    #files-panel h3 { margin: 0 0 4px; font-size: 13px; color: #444; }
    .file-item { margin: 2px 0; }
    .file-item .name { font-weight: 500; }
    .file-item .type { color: #666; margin-left: 4px; }

    .bottom-bar {
      padding: 8px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #question-input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    #send-btn {
      background: #00796b;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      color: #fff;
      cursor: pointer;
    }

    .action-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    input[type="file"] { font-size: 12px; }
    button {
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      color: #fff;
    }
    #upload-btn { background: #0288d1; }
    #export-pdf-btn { background: #e53935; }
    #export-pptx-btn { background: #3949ab; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>
  <header>
    <h1>Bone Assistant</h1>
    <div class="session-box">
      <span>Session ID：</span>
      <input id="session-id" type="text" value="test-1" />
    </div>
  </header>

  <main>
    <div class="container">
      <div id="messages"></div>

      <div id="files-panel">
        <h3>已上傳檔案：</h3>
        <div id="files-list">(尚未上傳任何檔案)</div>
      </div>

      <div class="bottom-bar">
        <div class="input-row">
          <input
            id="question-input"
            type="text"
            placeholder="輸入想問的問題，例如：『股骨的功能是什麼？』"
          />
          <button id="send-btn">送出</button>
        </div>

        <div class="action-row">
          <div>
            <input type="file" id="file-input" multiple />
            <button id="upload-btn">上傳檔案</button>
          </div>
          <div>
            <button id="export-pdf-btn">匯出 PDF</button>
            <button id="export-pptx-btn">匯出 PPT</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const BASE_URL = "http://127.0.0.1:8000";

    const sessionInput = document.getElementById("session-id");
    const messagesDiv = document.getElementById("messages");
    const filesPanel = document.getElementById("files-list");
    const questionInput = document.getElementById("question-input");
    const fileInput = document.getElementById("file-input");
    const sendBtn = document.getElementById("send-btn");
    const uploadBtn = document.getElementById("upload-btn");
    const exportPdfBtn = document.getElementById("export-pdf-btn");
    const exportPptxBtn = document.getElementById("export-pptx-btn");

    const localMessages = [];
    let serverMessageCount = 0;
    const uploadedFilesState = [];

    function appendMessage(role, content, type = "text") {
      const div = document.createElement("div");
      div.classList.add("msg");
      if (role === "system") div.classList.add("system");
      if (role === "user") div.classList.add("user");
      if (role === "assistant") div.classList.add("assistant");

      if (type === "text") {
        const label = role === "user" ? "我" :
                      role === "assistant" ? "GalaBone" : "系統";
        div.innerHTML = `<span class="label">${label}：</span>${content}`;
      } else if (type === "image") {
        div.innerHTML =
          `<span class="label">圖像：</span><br><img src="${content}" style="max-width:260px;margin-top:4px;">`;
      }
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function renderFilesList(filesState) {
      if (!filesState.length) {
        filesPanel.textContent = "(尚未上傳任何檔案)";
        return;
      }
      filesPanel.innerHTML = "";
      filesState.forEach(f => {
        const div = document.createElement("div");
        div.classList.add("file-item");
        div.innerHTML =
          `• <span class="name">${f.filename}</span>` +
          ` <span class="type">(${f.filetype || "unknown"})</span>`;
        filesPanel.appendChild(div);
      });
    }

    async function callAgentChat(payload) {
      const res = await fetch(BASE_URL + "/agent/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const txt = await res.text();
        appendMessage("system", `後端錯誤：${res.status} ${txt}`);
        return;
      }
      const data = await res.json();
      const all = data.messages || [];
      const newOnes = all.slice(serverMessageCount);
      serverMessageCount = all.length;

      newOnes.forEach(m => {
        localMessages.push(m);
        if (m.role === "user") return;
        if (m.type === "text" && m.content) {
          appendMessage(m.role, m.content, "text");
        } else if (m.type === "image" && m.url) {
          appendMessage(m.role, BASE_URL + m.url, "image");
        }
      });
    }

    async function handleSendText() {
      const text = questionInput.value.trim();
      if (!text) return;
      const sessionId = sessionInput.value.trim() || "web-session";
      questionInput.value = "";

      const userMsg = {
        role: "user",
        type: "text",
        content: text,
        url: null,
        filetype: null,
      };
      // 前端先畫一次自己的訊息
      appendMessage("user", text);

      await callAgentChat({
        session_id: sessionId,
        messages: [userMsg],
      });
    }

    async function handleUploadFiles() {
      const files = Array.from(fileInput.files || []);
      if (!files.length) return;
      const sessionId = sessionInput.value.trim() || "web-session";

      for (const file of files) {
        const form = new FormData();
        form.append("file", file);
        form.append("session_id", sessionId); // ★ 傳 session_id 給後端，讓後端把摘要寫進 session

        uploadBtn.disabled = true;
        try {
          const res = await fetch(BASE_URL + "/upload", {
            method: "POST",
            body: form,
          });
          if (!res.ok) {
            const txt = await res.text();
            appendMessage("system", `上傳失敗：${file.name} (${txt})`);
            continue;
          }
          const data = await res.json();

          uploadedFilesState.push({
            filename: data.filename || file.name,
            filetype: data.filetype,
            url: data.url,
          });
          renderFilesList(uploadedFilesState);

          const ext = (data.filetype || "").toLowerCase();

          if (["png", "jpg", "jpeg", "bmp"].includes(ext)) {
            // 圖片 → 丟給 /agent/chat 觸發 YOLO
            const imgMsg = {
              role: "user",
              type: "image",
              content: null,
              url: data.url,
              filetype: data.filetype,
            };
            localMessages.push(imgMsg);
            appendMessage("user", BASE_URL + data.url, "image");

            await callAgentChat({
              session_id: sessionId,
              messages: [imgMsg],
            });
          } else {
            // 文件 → 顯示摘要（後端同時已寫入 session）
            if (data.summary) {
              appendMessage(
                "assistant",
                `已讀取檔案「${data.filename || file.name}」，摘要如下：\n${data.summary}`
              );
              localMessages.push({
                role: "assistant",
                type: "text",
                content: `【檔案摘要】${data.summary}`,
                url: null,
                filetype: null,
              });
            } else {
              appendMessage(
                "system",
                `已上傳檔案：${file.name}（${data.filetype}），但後端未提供摘要。`
              );
            }
          }
        } catch (err) {
          console.error(err);
          appendMessage("system", `上傳時發生錯誤：${file.name}`);
        } finally {
          uploadBtn.disabled = false;
        }
      }

      fileInput.value = "";
    }

      async function exportReport(kind) {
        const sessionId = sessionInput.value.trim() || "web-session";

        // 只挑文字訊息，但保留整個物件結構（role / type / content / url / filetype）
        const exportMessages = localMessages.filter(
          (m) => m.type === "text" && m.content
        );

        const url =
          kind === "pdf" ? BASE_URL + "/export/pdf" : BASE_URL + "/export/pptx";

        const btn = kind === "pdf" ? exportPdfBtn : exportPptxBtn;
        btn.disabled = true;
        try {
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              session_id: sessionId,
              messages: exportMessages, // 直接送出
            }),
          });
        if (!res.ok) {
          const txt = await res.text();
          appendMessage("system", `匯出失敗：${res.status} ${txt}`);
          return;
        }
        const blob = await res.blob();
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = kind === "pdf" ? "bone_report.pdf" : "bone_report.pptx";
        document.body.appendChild(link);
        link.click();
        link.remove();
      } catch (err) {
        console.error(err);
        appendMessage("system", "匯出時發生錯誤，請稍後再試。");
      } finally {
        btn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", handleSendText);
    questionInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleSendText();
    });
    uploadBtn.addEventListener("click", handleUploadFiles);
    exportPdfBtn.addEventListener("click", () => exportReport("pdf"));
    exportPptxBtn.addEventListener("click", () => exportReport("pptx"));

    appendMessage(
      "system",
      "連線狀態：請確認後端已在 http://127.0.0.1:8000 執行中。\n" +
      "・文字問題 → /agent/chat 進行 RAG 回答。\n" +
      "・上傳圖片 → 觸發 YOLO 示範辨識。\n" +
      "・上傳 PDF/PPTX/Word/Excel/TXT → /upload 解析並產生摘要，寫入對話。\n" +
      "・匯出 PDF / PPTX → 依目前對話內容產生學習報告。"
    );
  </script>
</body>
</html>
